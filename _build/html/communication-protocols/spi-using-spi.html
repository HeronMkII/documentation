

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Using our SPI Library &mdash; UTAT Space Systems Documentation 1.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="UART (Universal Asynchronous Receiver Transmitter)" href="uart.html" />
    <link rel="prev" title="SPI Bus" href="spi-bus.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> UTAT Space Systems Documentation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/rtsys.html">Real-Time Embedded Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/avr-toolchain.html">The AVR Toolchain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/install.html">Software Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/install-mac.html">Software Installation - macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/install-win.html">Software Installation - Windows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/install-linux.html">Software Installation - Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/atmega32m1.html">The ATMega32M1 Microcontroller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/hello-world.html">Hello World ATMega32M1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/git-and-github.html">Git and Github</a></li>
</ul>
<p class="caption"><span class="caption-text">Software and Programming</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../software-and-programming.html">Software and Programming</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../software-tools/software-workflow.html">Software Workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../software-tools/test-harness.html">Test Harness</a></li>
<li class="toctree-l2"><a class="reference internal" href="../software-tools/our_toolchain.html">Our Toolchain</a></li>
<li class="toctree-l2"><a class="reference internal" href="../software-tools/lib-common.html">lib-common</a></li>
<li class="toctree-l2"><a class="reference internal" href="../software-tools/lib-common.html#switch-lib-common-to-a-different-branch">Switch lib-common to a Different Branch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../software-tools/uart-terminal.html">UART Terminal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting/troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../embedded/microcontrollers.html">Microcontrollers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../embedded/registers.html">Registers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../embedded/interrupts.html">Interrupts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../embedded/avr-fuses.html">AVR Fuses</a></li>
<li class="toctree-l2"><a class="reference internal" href="communication-protocols.html">Communication Protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="can.html">CAN (Controller Area Network)</a></li>
<li class="toctree-l2"><a class="reference internal" href="can-mobs.html">Message Objects (MObs)</a></li>
<li class="toctree-l2"><a class="reference internal" href="can-mob-allocation.html">MOb Allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="spi.html">SPI (Serial Peripheral Interface)</a></li>
<li class="toctree-l2"><a class="reference internal" href="spi-bus.html">SPI Bus</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Using our SPI Library</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#cs-pin">CS Pin</a></li>
<li class="toctree-l3"><a class="reference internal" href="#initialize-spi">Initialize SPI</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sending-a-spi-message">Sending a SPI message</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example-spi-code">Example SPI Code</a></li>
<li class="toctree-l3"><a class="reference internal" href="#more-clock-settings-advanced">More Clock Settings (advanced)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="uart.html">UART (Universal Asynchronous Receiver Transmitter)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/introduction.html">C Programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/variables.html">Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/operators.html">Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/bitwise-operators.html">Bitwise Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/control-structures.html">Control Structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/functions.html">Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/header-files.html">Header Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/header-files.html#define">#define</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/header-files.html#typedef">typedef</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/pointers.html">Pointers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/structs.html">Structs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/c_h_files.html"><code class="docutils literal"><span class="pre">.c</span></code> and <code class="docutils literal"><span class="pre">.h</span></code> Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/binary-hex-literals.html">Binary (0b) and Hexadecimal (0x) Literals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/integer-types.html">Integer Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/print-formatting.html">Print Formatting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/volatile-variables.html">Volatile Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../style-guide/style-guide.html">Software Style Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../style-guide/technical.html">Technical</a></li>
<li class="toctree-l2"><a class="reference internal" href="../style-guide/formatting.html">Formatting</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Electronics and Altium</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../electronics-and-altium.html">Electronics and Altium</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">UTAT Space Systems Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../software-and-programming.html">Software and Programming</a> &raquo;</li>
        
      <li>Using our SPI Library</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/communication-protocols/spi-using-spi.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="using-our-spi-library">
<span id="using-our-spi-library"></span><h1>Using our SPI Library<a class="headerlink" href="#using-our-spi-library" title="Permalink to this headline">¶</a></h1>
<p>Here are the basic software steps to send SPI messages.</p>
<p>Setup:</p>
<ol class="simple">
<li>Initialize SPI</li>
<li>Initialize CS as an output pin</li>
<li>Set CS high</li>
</ol>
<p>Transmission:</p>
<ol class="simple">
<li>Set CS low</li>
<li>Send SPI message</li>
<li>Set CS high</li>
</ol>
<div class="section" id="cs-pin">
<span id="cs-pin"></span><h2>CS Pin<a class="headerlink" href="#cs-pin" title="Permalink to this headline">¶</a></h2>
<p>On our microcontroller each IO pin has three registers that control it. We will only need to use two of them. There is the data direction register that controls if the pin is input our output and there is the port register that lets you write high or low on the pin.</p>
<p>Once you figure out what pin you are using for CS you can check the microcontroller’s datasheet to get the name of the pin. Figure 1 shows the pin configuration for the ATmega32m1 microcontroller.</p>
<p><img alt="ATmega32m1 pinout" src="../_images/32m1.png" /></p>
<p>There are four banks of ports (B, C, D and E) with eight pins on each. There are 8-bit data direction and port registers for each of the four ports. Each bit in the register is for a separate pin. The data direction register is called DDRx and the port register is just called PORTx where x is the port. So if you wanted to initialized PB6 as output the code would be the following.</p>
<p><img alt="" src="../_images/ddrb.jpg" /></p>
<p>The macro <code class="docutils literal"><span class="pre">_BV(PB6)</span></code> expands to <code class="docutils literal"><span class="pre">1</span> <span class="pre">&lt;&lt;</span> <span class="pre">PB6</span></code> and PB6 is a macro that expands to 6. Here is the code to write high or low on PB6.</p>
<p><img alt="" src="../_images/portb.jpg" /></p>
<p>In our SPI library we have functions that will do this for you. This is how you use them.</p>
<p><img alt="" src="../_images/spi_fn.jpg" /></p>
</div>
<div class="section" id="initialize-spi">
<span id="initialize-spi"></span><h2>Initialize SPI<a class="headerlink" href="#initialize-spi" title="Permalink to this headline">¶</a></h2>
<p>We have a function, <code class="docutils literal"><span class="pre">init_spi()</span></code> that does this. It initializes SCK and MOSI as output and sets the SCK frequency to 8 MHz / 64. The 32M1’s internal clock frequency is 8 MHz.</p>
</div>
<div class="section" id="sending-a-spi-message">
<span id="sending-a-spi-message"></span><h2>Sending a SPI message<a class="headerlink" href="#sending-a-spi-message" title="Permalink to this headline">¶</a></h2>
<p>SPI sends 8 bit messages. If you want to send more than a byte you can send consecutive SPI messages. This is how you do it.</p>
<p><img alt="" src="../_images/spi_msg.jpg" /></p>
</div>
<div class="section" id="example-spi-code">
<span id="example-spi-code"></span><h2>Example SPI Code<a class="headerlink" href="#example-spi-code" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">Example from PAY:</span>
<span class="cm">Say we want to use the pin labelled PB5 on the 32M1 as the CS pin for the SPI device.</span>
<span class="cm">It uses pin 5 on DDR B (data direction register) and Port B (output).</span>
<span class="cm">*/</span>

<span class="c1">// This would be in a header file</span>
<span class="cp">#define CS PB5</span>
<span class="cp">#define CS_PORT PORTB</span>
<span class="cp">#define CS_DDR DDRB</span>




<span class="c1">// Setup: Just do this once</span>

<span class="c1">// Initialize SPI</span>
<span class="n">init_spi</span><span class="p">();</span>

<span class="c1">// Initialize CS pin as an output pin</span>
<span class="n">init_cs</span><span class="p">(</span><span class="n">CS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">CS_DDR</span><span class="p">);</span>   <span class="c1">// pin, DDR</span>

<span class="c1">// Set CS pin high (disable SPI device by default)</span>
<span class="n">set_cs_high</span><span class="p">(</span><span class="n">CS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">CS_PORT</span><span class="p">);</span>




<span class="c1">// Transmission: do this every time you want to transmit</span>

<span class="c1">// Start transmission: set CS pin low (enable SPI device)</span>
<span class="n">set_cs_low</span><span class="p">(</span><span class="n">CS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">CS_PORT</span><span class="p">);</span>  <span class="c1">// pin, port</span>

<span class="c1">// Send and/or receive data: call send_spi() for each byte</span>
<span class="kt">uint8_t</span> <span class="n">received1</span> <span class="o">=</span> <span class="n">send_spi</span><span class="p">(</span><span class="mh">0xA4</span><span class="p">);</span> <span class="c1">// if you want to both send and receive</span>
<span class="kt">uint8_t</span> <span class="n">received2</span> <span class="o">=</span> <span class="n">send_spi</span><span class="p">(</span><span class="mh">0x00</span><span class="p">);</span> <span class="c1">// if you just want to receive (send 0)</span>
<span class="n">send_spi</span><span class="p">(</span><span class="mh">0xA4</span><span class="p">);</span>                     <span class="c1">// if you just want to send (ignore received)</span>

<span class="c1">// End transmission: set CS pin high (disable SPI device)</span>
<span class="n">set_cs_high</span><span class="p">(</span><span class="n">CS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">CS_PORT</span><span class="p">);</span>
</pre></div>
</div>
<p>This is another full SPI program to make sure SPI is running correctly on the microcontroller.</p>
<p><img alt="" src="../_images/spi_example_code.jpg" /></p>
<p>This repeatedly sends <code class="docutils literal"><span class="pre">10101010</span></code>.</p>
</div>
<div class="section" id="more-clock-settings-advanced">
<span id="more-clock-settings-advanced"></span><h2>More Clock Settings (advanced)<a class="headerlink" href="#more-clock-settings-advanced" title="Permalink to this headline">¶</a></h2>
<p><img alt="" src="../_images/spi_modes.jpg" /></p>
<p>The two clock settings introduced here are Clock Polarity and Clock Phase. Clock Phase determines whether data is shifted in and out on the rising or falling edge of the data clock cycle. Clock Polarity determines determines whether the clock is idle when high or low.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="uart.html" class="btn btn-neutral float-right" title="UART (Universal Asynchronous Receiver Transmitter)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="spi-bus.html" class="btn btn-neutral" title="SPI Bus" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, University of Toronto Aerospace Team.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>