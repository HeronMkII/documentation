
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>CAN (Controller Area Network) &#8212; utatss-documentation 1.0 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="can-controller-area-network">
<span id="can-controller-area-network"></span><h1>CAN (Controller Area Network)<a class="headerlink" href="#can-controller-area-network" title="Permalink to this headline">¶</a></h1>
<p>CAN is a communication transfer protocol that we use to communicate between 32M1 microcontrollers in different subsystems. CAN transmits “messages”, which can each contain up to 8 bytes of data.</p>
<div class="section" id="acronyms">
<span id="acronyms"></span><h2>Acronyms<a class="headerlink" href="#acronyms" title="Permalink to this headline">¶</a></h2>
<p><strong>RX</strong> - Receiving</p>
<p><strong>TX</strong> - Transmitting</p>
<p><strong>MOB</strong> - A message object (like a mailbox) that transmits or receives particular types of messages.</p>
<p><strong>CAN Transceiver</strong> - The hardware device connected to each 32M1 that transmits and recives CAN messages on the bus</p>
<p><strong>CAN Bus</strong> - The set of wires connecting all CAN transceivers</p>
<p><strong>CANH</strong> - CAN high (bus wire)</p>
<p><strong>CANL</strong> - CAN low (bus wire)</p>
</div>
<div class="section" id="hardware">
<span id="hardware"></span><h2>Hardware<a class="headerlink" href="#hardware" title="Permalink to this headline">¶</a></h2>
<p>Each 32M1 is connected to its own CAN transceiver, which handles transmitting and receiving CAN messages. The CAN bus connects all the CAN transceivers using two wires called CANH and CANL. The signal on the bus is defined as the difference between the CANH and CANL voltages.</p>
</div>
<div class="section" id="mobs">
<span id="mobs"></span><h2>MOBs<a class="headerlink" href="#mobs" title="Permalink to this headline">¶</a></h2>
<p>A MOB (message object) behaves like a mailbox that transmits or receives particular types of messages. It must be designated as either RX (receiving) or TX (transmitting). Each RX MOB has a mask (filter) that determines which messages it receives.</p>
<p>Each MOB is defined as a struct in C.</p>
</div>
<div class="section" id="rx-mobs">
<span id="rx-mobs"></span><h2>RX MOBs<a class="headerlink" href="#rx-mobs" title="Permalink to this headline">¶</a></h2>
<p>Here is an example of an RX mob on PAY that receives commands for requesting sensor data. See later documentation for how these values are assigned.</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">mob_t</span> <span class="n">cmd_rx_mob</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">mob_num</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>                  <span class="c1">// MOB number</span>
    <span class="p">.</span><span class="n">mob_type</span> <span class="o">=</span> <span class="n">RX_MOB</span><span class="p">,</span>            <span class="c1">// MOB type (RX)</span>
    <span class="p">.</span><span class="n">dlc</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>                      <span class="c1">// Expected length of CAN message (number of bytes)</span>
    <span class="p">.</span><span class="n">id_tag</span> <span class="o">=</span> <span class="n">PAY_CMD_RX_MOB_ID</span><span class="p">,</span>   <span class="c1">// Tag is used to determine which messages to receive</span>
    <span class="p">.</span><span class="n">id_mask</span> <span class="o">=</span> <span class="n">CAN_RX_MASK_ID</span><span class="p">,</span>     <span class="c1">// Mask is a filter that is combined with the tag to determine which messages to receive</span>
    <span class="p">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">default_rx_ctrl</span><span class="p">,</span>       <span class="c1">// Control bits (leave as default)</span>

    <span class="p">.</span><span class="n">rx_cb</span> <span class="o">=</span> <span class="n">cmd_rx_callback</span>       <span class="c1">// The function to be called when this MOB receives a message</span>
<span class="p">};</span>
</pre></div>
</div>
<p>If you want the RX MOB to receive all messages, such as for testing, set its mask to 0.</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="p">.</span><span class="n">id_mask</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0000</span> <span class="p">}</span>
</pre></div>
</div>
<p>When the RX MOB receives a CAN message, it will trigger an interrupt and call the function specified in <code class="docutils literal notranslate"><span class="pre">rx_cb</span></code>. The CAN system passes the received data bytes and the length (number of bytes) to your function, which you can process however you want. For example:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">cmd_rx_callback</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">print</span><span class="p">(</span><span class="s">&quot;RX Callback</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="c1">// Print the bytes in hex (%02x means 2 digits at a time)</span>
    <span class="n">print</span><span class="p">(</span><span class="s">&quot;Received Message:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">print</span><span class="p">(</span><span class="s">&quot;0x%02x &quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="n">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="c1">// ...</span>
    <span class="c1">// Process the data</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="tx-mobs">
<span id="tx-mobs"></span><h2>TX MOBs<a class="headerlink" href="#tx-mobs" title="Permalink to this headline">¶</a></h2>
<p>Here is an example of an TX mob on PAY that transmits commands with sensor data. See later documentation for how these values are assigned.</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">mob_t</span> <span class="n">data_tx_mob</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">mob_num</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>                   <span class="c1">// MOB number</span>
    <span class="p">.</span><span class="n">mob_type</span> <span class="o">=</span> <span class="n">TX_MOB</span><span class="p">,</span>             <span class="c1">// MOB type (TX)</span>
    <span class="p">.</span><span class="n">id_tag</span> <span class="o">=</span> <span class="n">PAY_DATA_TX_MOB_ID</span><span class="p">,</span>   <span class="c1">// The receiving MOB will match this tag with its own tag and mask</span>
    <span class="p">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">default_tx_ctrl</span><span class="p">,</span>        <span class="c1">// Control bits (leave as default)</span>

    <span class="p">.</span><span class="n">tx_data_cb</span> <span class="o">=</span> <span class="n">data_tx_callback</span>  <span class="c1">// The function to be called before this MOB transmits a message</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Unlike an RX MOB, the TX MOB does not activate on its own. When you want to transmit a CAN message, you must activate it by “resuming” it. In this example, when you call <code class="docutils literal notranslate"><span class="pre">resume_mob(&amp;data_tx_mob)</span></code>, it will resume the TX MOB, triggering an interrupt and calling the function specified in <code class="docutils literal notranslate"><span class="pre">tx_data_cb</span></code>. The CAN system allocates space for the data bytes and the length (number of bytes) to transmit, passing pointers to them to your function. You must get the necessary data and place it in those memory locations (using the pointers). When the function ends, the CAN system takes that data and transmits the CAN message. The MOB then “pauses” itself until you call <code class="docutils literal notranslate"><span class="pre">resume_mob(&amp;data_tx_mob)</span></code> again. For example:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">data_tx_callback</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">print</span><span class="p">(</span><span class="s">&quot;TX Callback</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="c1">// Normally we would retrieve some sort of sensor data</span>
    <span class="c1">// For this example, just transmit the bytes 0x00 0x01 0x02 0x03</span>

    <span class="c1">// Want to transmit 4 bytes</span>
    <span class="o">*</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

    <span class="c1">// Set the data</span>
    <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
    <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
    <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
    <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>

    <span class="c1">// After this function ends, the CAN system will transmit this message</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="initializing-can">
<span id="initializing-can"></span><h2>Initializing CAN<a class="headerlink" href="#initializing-can" title="Permalink to this headline">¶</a></h2>
<p>At the beginning of your program, you must initialize the CAN system and each individual MOB. For example:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="c1">// Enable CAN interrupts and the CAN transceiver</span>
<span class="n">init_can</span><span class="p">();</span>

<span class="c1">// Initialize MOBs (note the different functions for RX and TX)</span>
<span class="n">init_rx_mob</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd_rx_mob</span><span class="p">);</span>
<span class="n">init_tx_mob</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data_tx_mob</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">CAN (Controller Area Network)</a><ul>
<li><a class="reference internal" href="#acronyms">Acronyms</a></li>
<li><a class="reference internal" href="#hardware">Hardware</a></li>
<li><a class="reference internal" href="#mobs">MOBs</a></li>
<li><a class="reference internal" href="#rx-mobs">RX MOBs</a></li>
<li><a class="reference internal" href="#tx-mobs">TX MOBs</a></li>
<li><a class="reference internal" href="#initializing-can">Initializing CAN</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/communication-protocols/can.md.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, University of Toronto Aerospace Team [D[D[D[D[D[D[D[D[D[D[D[D[D[D[D[D[D[D[D[D[D[D[D[D[D[D[D[C[D[D[D[D[D[D[D[D[D[D[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C): University of Toronto Aerospace Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="../_sources/communication-protocols/can.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>