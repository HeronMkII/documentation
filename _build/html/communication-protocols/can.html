

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>CAN (Controller Area Network) &mdash; UTAT Space Systems Documentation 1.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Message Objects (MObs)" href="can-mobs.html" />
    <link rel="prev" title="Communication Protocols" href="communication-protocols.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> UTAT Space Systems Documentation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/rtsys.html">Real-Time Embedded Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/avr-toolchain.html">The AVR Toolchain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/install.html">Software Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/install-mac.html">Software Installation - macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/install-win.html">Software Installation - Windows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/install-linux.html">Software Installation - Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/atmega32m1.html">The ATMega32M1 Microcontroller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/hello-world.html">Hello World ATMega32M1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/git-and-github.html">Git and Github</a></li>
</ul>
<p class="caption"><span class="caption-text">Software and Programming</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../software-and-programming.html">Software and Programming</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../software-tools/software-workflow.html">Software Workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../software-tools/test-harness.html">Test Harness</a></li>
<li class="toctree-l2"><a class="reference internal" href="../software-tools/our_toolchain.html">Our Toolchain</a></li>
<li class="toctree-l2"><a class="reference internal" href="../software-tools/lib-common.html">lib-common</a></li>
<li class="toctree-l2"><a class="reference internal" href="../software-tools/lib-common.html#switch-lib-common-to-a-different-branch">Switch lib-common to a Different Branch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../software-tools/uart-terminal.html">UART Terminal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting/troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../embedded/microcontrollers.html">Microcontrollers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../embedded/registers.html">Registers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../embedded/interrupts.html">Interrupts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../embedded/avr-fuses.html">AVR Fuses</a></li>
<li class="toctree-l2"><a class="reference internal" href="communication-protocols.html">Communication Protocols</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">CAN (Controller Area Network)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#acronyms">Acronyms</a></li>
<li class="toctree-l3"><a class="reference internal" href="#hardware">Hardware</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mobs">MOBs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rx-mobs">RX MOBs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tx-mobs">TX MOBs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#initializing-can">Initializing CAN</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="can-mobs.html">Message Objects (MObs)</a></li>
<li class="toctree-l2"><a class="reference internal" href="can-mob-allocation.html">MOb Allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="spi.html">SPI (Serial Peripheral Interface)</a></li>
<li class="toctree-l2"><a class="reference internal" href="spi-bus.html">SPI Bus</a></li>
<li class="toctree-l2"><a class="reference internal" href="spi-using-spi.html">Using our SPI Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="uart.html">UART (Universal Asynchronous Receiver Transmitter)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/introduction.html">C Programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/variables.html">Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/operators.html">Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/bitwise-operators.html">Bitwise Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/control-structures.html">Control Structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/functions.html">Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/header-files.html">Header Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/header-files.html#define">#define</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/header-files.html#typedef">typedef</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/pointers.html">Pointers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/structs.html">Structs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/c_h_files.html"><code class="docutils literal"><span class="pre">.c</span></code> and <code class="docutils literal"><span class="pre">.h</span></code> Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/binary-hex-literals.html">Binary (0b) and Hexadecimal (0x) Literals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/integer-types.html">Integer Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/print-formatting.html">Print Formatting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c-programming/volatile-variables.html">Volatile Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../style-guide/style-guide.html">Software Style Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../style-guide/technical.html">Technical</a></li>
<li class="toctree-l2"><a class="reference internal" href="../style-guide/formatting.html">Formatting</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Electronics and Altium</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../electronics-and-altium.html">Electronics and Altium</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">UTAT Space Systems Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../software-and-programming.html">Software and Programming</a> &raquo;</li>
        
      <li>CAN (Controller Area Network)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/communication-protocols/can.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="can-controller-area-network">
<span id="can-controller-area-network"></span><h1>CAN (Controller Area Network)<a class="headerlink" href="#can-controller-area-network" title="Permalink to this headline">¶</a></h1>
<p>CAN is a communication transfer protocol that we use to communicate between 32M1 microcontrollers in different subsystems. CAN transmits <strong>messages</strong>, which can each contain up to 8 bytes of data.</p>
<div class="section" id="acronyms">
<span id="acronyms"></span><h2>Acronyms<a class="headerlink" href="#acronyms" title="Permalink to this headline">¶</a></h2>
<p><strong>RX</strong> - Receiving</p>
<p><strong>TX</strong> - Transmitting</p>
<p><strong>MOB/MOb</strong> - A message object (like a mailbox) that transmits or receives particular types of messages.</p>
<p><strong>CAN Transceiver</strong> - The hardware device connected to each 32M1 that transmits and recives CAN messages on the bus.</p>
<p><strong>CAN Bus</strong> - The set of wires connecting all CAN transceivers.</p>
<p><strong>CANH</strong> - CAN high (bus wire)</p>
<p><strong>CANL</strong> - CAN low (bus wire)</p>
</div>
<div class="section" id="hardware">
<span id="hardware"></span><h2>Hardware<a class="headerlink" href="#hardware" title="Permalink to this headline">¶</a></h2>
<p>Each 32M1 is connected to its own CAN transceiver, which handles transmitting and receiving CAN messages. The CAN bus connects all the CAN transceivers using two wires called CANH and CANL. The signal on the bus is defined as the difference between the CANH and CANL voltages.</p>
</div>
<div class="section" id="mobs">
<span id="mobs"></span><h2>MOBs<a class="headerlink" href="#mobs" title="Permalink to this headline">¶</a></h2>
<p>A MOB (message object) behaves like a mailbox that transmits or receives particular types of messages. It must be designated as either RX (receiving) or TX (transmitting). Each RX MOB has a mask (filter) that determines which messages it receives.</p>
<p>Each MOB is defined as a struct in C.</p>
</div>
<div class="section" id="rx-mobs">
<span id="rx-mobs"></span><h2>RX MOBs<a class="headerlink" href="#rx-mobs" title="Permalink to this headline">¶</a></h2>
<p>Here is an example of an RX mob on PAY that receives commands for requesting sensor data. See later documentation for how these values are assigned.</p>
<div class="highlight-C"><div class="highlight"><pre><span></span><span class="n">mob_t</span> <span class="n">cmd_rx_mob</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">mob_num</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>                  <span class="c1">// MOB number</span>
    <span class="p">.</span><span class="n">mob_type</span> <span class="o">=</span> <span class="n">RX_MOB</span><span class="p">,</span>            <span class="c1">// MOB type (RX)</span>
    <span class="p">.</span><span class="n">dlc</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>                      <span class="c1">// Expected length of CAN message (number of bytes)</span>
    <span class="p">.</span><span class="n">id_tag</span> <span class="o">=</span> <span class="n">PAY_CMD_RX_MOB_ID</span><span class="p">,</span>   <span class="c1">// Tag is used to determine which messages to receive</span>
    <span class="p">.</span><span class="n">id_mask</span> <span class="o">=</span> <span class="n">CAN_RX_MASK_ID</span><span class="p">,</span>     <span class="c1">// Mask is a filter that is combined with the tag to determine which messages to receive</span>
    <span class="p">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">default_rx_ctrl</span><span class="p">,</span>       <span class="c1">// Control bits (leave as default)</span>

    <span class="p">.</span><span class="n">rx_cb</span> <span class="o">=</span> <span class="n">cmd_rx_callback</span>       <span class="c1">// The function to be called when this MOB receives a message</span>
<span class="p">};</span>
</pre></div>
</div>
<p>If you want the RX MOB to receive all messages, such as for testing, set its mask to 0.</p>
<div class="highlight-C"><div class="highlight"><pre><span></span><span class="p">.</span><span class="n">id_mask</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0000</span> <span class="p">}</span>
</pre></div>
</div>
<p>When the RX MOB receives a CAN message, it will trigger an interrupt and call the function specified in <code class="docutils literal"><span class="pre">rx_cb</span></code>. The CAN system passes the received data bytes and the length (number of bytes) to your function, which you can process however you want. For example:</p>
<div class="highlight-C"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">cmd_rx_callback</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">print</span><span class="p">(</span><span class="s">&quot;RX Callback</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="c1">// Print the bytes in hex (%02x means 2 digits at a time)</span>
    <span class="n">print</span><span class="p">(</span><span class="s">&quot;Received Message:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">print</span><span class="p">(</span><span class="s">&quot;0x%02x &quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="n">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="c1">// ...</span>
    <span class="c1">// Process the data</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="tx-mobs">
<span id="tx-mobs"></span><h2>TX MOBs<a class="headerlink" href="#tx-mobs" title="Permalink to this headline">¶</a></h2>
<p>Here is an example of an TX mob on PAY that transmits commands with sensor data. See later documentation for how these values are assigned.</p>
<div class="highlight-C"><div class="highlight"><pre><span></span><span class="n">mob_t</span> <span class="n">data_tx_mob</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">mob_num</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>                   <span class="c1">// MOB number</span>
    <span class="p">.</span><span class="n">mob_type</span> <span class="o">=</span> <span class="n">TX_MOB</span><span class="p">,</span>             <span class="c1">// MOB type (TX)</span>
    <span class="p">.</span><span class="n">id_tag</span> <span class="o">=</span> <span class="n">PAY_DATA_TX_MOB_ID</span><span class="p">,</span>   <span class="c1">// The receiving MOB will match this tag with its own tag and mask</span>
    <span class="p">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">default_tx_ctrl</span><span class="p">,</span>        <span class="c1">// Control bits (leave as default)</span>

    <span class="p">.</span><span class="n">tx_data_cb</span> <span class="o">=</span> <span class="n">data_tx_callback</span>  <span class="c1">// The function to be called before this MOB transmits a message</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Unlike an RX MOB, the TX MOB does not activate on its own. When you want to transmit a CAN message, you must activate it by “resuming” it. In this example, when you call <code class="docutils literal"><span class="pre">resume_mob(&amp;data_tx_mob)</span></code>, it will resume the TX MOB, triggering an interrupt and calling the function specified in <code class="docutils literal"><span class="pre">tx_data_cb</span></code>. The CAN system allocates space for the data bytes and the length (number of bytes) to transmit, passing pointers to them to your function. You must get the necessary data and place it in those memory locations (using the pointers). When the function ends, the CAN system takes that data and transmits the CAN message. The MOB then “pauses” itself until you call <code class="docutils literal"><span class="pre">resume_mob(&amp;data_tx_mob)</span></code> again. For example:</p>
<div class="highlight-C"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">data_tx_callback</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">print</span><span class="p">(</span><span class="s">&quot;TX Callback</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="c1">// Normally we would retrieve some sort of sensor data</span>
    <span class="c1">// For this example, just transmit the bytes 0x00 0x01 0x02 0x03</span>

    <span class="c1">// Want to transmit 4 bytes</span>
    <span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

    <span class="c1">// Set the data</span>
    <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
    <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
    <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
    <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>

    <span class="c1">// After this function ends, the CAN system will transmit this message</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="initializing-can">
<span id="initializing-can"></span><h2>Initializing CAN<a class="headerlink" href="#initializing-can" title="Permalink to this headline">¶</a></h2>
<p>At the beginning of your program, you must initialize the CAN system and each individual MOB. For example:</p>
<div class="highlight-C"><div class="highlight"><pre><span></span><span class="c1">// Enable CAN interrupts and the CAN transceiver</span>
<span class="n">init_can</span><span class="p">();</span>

<span class="c1">// Initialize MOBs (note the different functions for RX and TX)</span>
<span class="n">init_rx_mob</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd_rx_mob</span><span class="p">);</span>
<span class="n">init_tx_mob</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data_tx_mob</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="can-mobs.html" class="btn btn-neutral float-right" title="Message Objects (MObs)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="communication-protocols.html" class="btn btn-neutral" title="Communication Protocols" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, University of Toronto Aerospace Team.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>